# CLAUDE.md - Project Instructions for Claude Code

## Project Overview

**clsecure** is a bash script that runs Claude Code in an isolated environment using dedicated Linux users and optional namespace/container isolation.

## Key Files

- `clsecure` - Built single-file script (production, generated by build.sh)
- `clsecure-src` - Modular main script (development)
- `lib/*.sh` - Module library (11 modules)
- `build.sh` - Build script (generates clsecure from modules)
- `run_tests.sh` - Test runner
- `UPGRADE-GUIDE.md` - Instructions for upgrading isolation modes

## Architecture

The script creates a dedicated Linux user (`claude-worker-<project>`) per project, clones the git repository to that user's home directory, and runs Claude Code as that user with restricted permissions.

### Isolation Modes

1. **user** - Basic user isolation (security: 6/10)
2. **namespace** - User + firejail namespace (security: 8/10) - RECOMMENDED
3. **container** - User + podman rootless container (security: 9/10)

## Development Guidelines

### Modular Architecture

**clsecure** uses a modular structure:
- **`clsecure-src`** - Main orchestration script (CLI parsing, workflow)
- **`lib/vars.sh`** - Variable initialization (must be sourced first)
- **`lib/logging.sh`** - Logging functions
- **`lib/lock.sh`** - Lock management
- **`lib/config.sh`** - Configuration loading
- **`lib/worker.sh`** - Worker user management
- **`lib/git.sh`** - Git operations
- **`lib/sanitize.sh`** - Path sanitization
- **`lib/deps.sh`** - Dependency installation
- **`lib/isolation.sh`** - Isolation execution
- **`lib/sync.sh`** - Sync-back logic
- **`lib/cleanup.sh`** - Session cleanup (hooks + process termination)

### Module Development

1. **Dependency Order:** Modules must be sourced in dependency order (see `clsecure-src` lines 15-40)
2. **Module Headers:** Each module must have a header documenting:
   - Dependencies
   - Exported functions
   - Usage examples
3. **Variable Exports:** Variables used across modules must be exported in `lib/vars.sh`
4. **Function Exports:** All functions are automatically available after sourcing

### Shell Script Style

- Use `set -euo pipefail` at the start
- Use functions for reusable logic
- Use color-coded logging: `log_info`, `log_warn`, `log_error`, `log_step`, `log_security`
- Validate all user inputs
- Quote all variables: `"$VAR"` not `$VAR`

### Development Workflow

```bash
# 1. Edit modules
vim lib/worker.sh
vim clsecure-src

# 2. Rebuild single-file distribution
./build.sh

# 3. Run tests
./run_tests.sh

# 4. Test functionality
cd /tmp/test-project
git init
./clsecure --help
./clsecure --mode user
```

### Testing Changes

```bash
# Run unit tests
./run_tests.sh

# Test in a safe directory
cd /tmp/test-project
git init
clsecure --help

# Test isolation modes
clsecure --mode user
clsecure --mode namespace
```

### Build Process

The `build.sh` script:
1. Concatenates all modules in dependency order
2. Calls `init_clsecure_vars()` after modules are loaded
3. Extracts main script logic from `clsecure-src`
4. Creates single-file `clsecure` for distribution

**Pre-commit hook** automatically verifies build consistency.

**Important:** You must rebuild `clsecure` before committing changes to `clsecure-src` or `lib/*.sh`. The pre-commit hook will automatically run `build.sh` and verify consistency. If `clsecure` is out of sync, the commit will fail with instructions to rebuild.

**Workflow:**
```bash
# 1. Edit modules
vim lib/worker.sh
vim clsecure-src

# 2. Rebuild (or let pre-commit do it)
./build.sh

# 3. Commit (pre-commit verifies build)
git add clsecure-src lib/ clsecure
git commit -m "Update modules"
```

See `BUILD-WORKFLOW.md` for detailed build process documentation.

### Common Tasks

```bash
# List worker users
clsecure --list

# Clean up workers
clsecure --cleanup

# Show isolation info
clsecure --info

# Run multiple sessions for the same project
clsecure --session auth       # separate worker for auth work
clsecure --session payments   # separate worker for payments work

# Debug shell with a named session
clsecure --shell --skip-setup --session mytest
```

### Project-Level Config

Projects can provide a `.clsecure/config` file with safe settings (mode, cleanup_hook_timeout, skip_docker_autodetect). Security-sensitive settings (docker, network, setup_script, install_dependencies) are only accepted from user config (`~/.config/clsecure/config`) or CLI flags.

Precedence: CLI flags > User config > Project config > Defaults

### Cleanup Hooks

Projects can provide a `.clsecure/on-cleanup` executable that runs when a session ends.
The hook receives environment variables:
- `CLSECURE_SESSION` - session name
- `CLSECURE_CLEANUP_LEVEL` - `stop` (keep data) or `purge` (destroy data)
- `CLSECURE_PROJECT_DIR` - project path inside worker home
- `CLSECURE_WORKER_USER` - worker username
- `CLSECURE_WORKER_HOME` - worker home directory

Example `.clsecure/on-cleanup`:
```bash
#!/bin/bash
export COMPOSE_PROJECT_NAME="myapp-${CLSECURE_SESSION:-default}"
case "$CLSECURE_CLEANUP_LEVEL" in
    stop)  docker compose down ;;
    purge) docker compose down -v --remove-orphans ;;
esac
```

If no hook exists but docker is enabled, clsecure auto-detects compose files
and runs `docker compose down` as a fallback.

## Important Notes

- Script must be run from a git repository
- Requires: git, rsync, sudo
- For namespace mode: firejail
- For container mode: podman
- Git submodules are copied from the source directory (avoids SSH key requirements for worker users)

## Installation

```bash
sudo install -m 755 clsecure /usr/local/bin/
```

